<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Tests of Prettifier w/ large data files</title>
<script type="text/javascript" src="../src/prettify.js"></script>
<style type="text/css">
#log { white-space: pre; }
</style>
</head>

<body>
<div id="log"></div>
<div id="report"></div>

<script type="text/javascript">
function now() {
  return (Date.now) ? Date.now() : (new Date()).getTime();
}

function logger(msg) {
  if (typeof console !== 'undefined' && console.log) {
    console.log(msg);
  }
  var pre = document.createElement('PRE');
  pre.appendChild(document.createTextNode(msg));
  document.getElementById('log').appendChild(pre);
}

// Generate inputs of various sizes so that we can try fitting a curve to the
// run times.
(function () {
  var tasks = [];
  var jsonTimes = [];
  var xmlTimes = [];

  function makeTargets(lang, item, sep, preText, postText, timesList) {
   var buffer = [];
    for (var i = 512; --i >= 0;) { buffer.push(item); }
    var count = 512;
    for (var i = 6; --i >= 0;) {
     var src = buffer.join(sep);
      tasks.push((function (n, source) {
        return function () {
          logger('starting ' + lang + ' ' + n);
          var t0 = now();
          var result = PR.prettyPrintOne(source, lang, false);
          var t1 = now();
          logger('finishing ' + lang + ' ' + n);
          if (result === source) {
            logger('Failed to prettify ' + lang + ' ' + n);
          } else {
            timesList.push([n, t1 - t0, source.length]);
          }
        };
      })(count, preText + src + postText));

      buffer = [src, src];
      count *= 2;
    }
  }

  function emitBenchmarkTable(title, times) {
    var html = [
        '<h2>', title, '<\/h2>',
        '<table class="benchmark"><tr><th>Count<th>Length<th>Time<th>Items Per Second'];
    for (var i = 0; i < times.length; ++i) {
      var time = times[i];
      var count = time[0], deltaMs = time[1], length = time[2];
      html.push('<tr><td>', count, '<td>', length, '<td>', deltaMs,
                '<td>', (count * 1000 / deltaMs).toFixed(1));
    }
    html.push('<\/table>');

    var div = document.createElement('DIV');
    div.innerHTML = html.join('');
    document.getElementById('report').appendChild(div);
  }

  function doOne() {
    var task = tasks.shift();
    task();
    if (tasks.length) {
      setTimeout(doOne, 250);
    }
  }

  var listItem = (
      '&lt;li class="friendly" style="blink: like-its-going-out-of-style"&gt;'
      + '&lt;b&gt;Howdy&lt;/b&gt; Neighbor&lt;/li&gt;');
  makeTargets('xml', listItem, '\n', '<ul>', '<\/ul>', xmlTimes);
  tasks.push(function () { emitBenchmarkTable('XML', xmlTimes); });

  var jsonItem = (
      '{ "friendly": true, "blinking": "hell-yes", "greeting": "Howdy!" }');
  makeTargets('json', jsonItem, ', ', '[', ']', jsonTimes);
  tasks.push(function () { emitBenchmarkTable('JSON', jsonTimes); });

  setTimeout(doOne, 250);
})();
</script>

</body>
</html>
